[
  {
    "type": "waitTime",
    "config": {
      "timeoutType": "fixedValue",
      "timeout": 1000,
      "timeoutMin": 1000,
      "timeoutMax": 300000,
      "remark": ""
    }
  },
  {
    "type": "newPage",
    "config": {}
  },
  {
    "type": "gotoUrl",
    "config": {
      "url": "https://discord.com/channels/@me",
      "timeout": 30000,
      "remark": ""
    }
  },
  {
    "type": "closeOtherPage",
    "config": {}
  },
  {
    "type": "waitTime",
    "config": {
      "timeoutType": "randomInterval",
      "timeout": 1000,
      "timeoutMin": 8000,
      "timeoutMax": 10000,
      "remark": ""
    }
  },
  {
    "type": "javaScript",
    "config": {
      "params": [],
      "content": "try {\n    const isAuthedByPath = !location.pathname.startsWith('/login');\n    const hasDM = !!document.querySelector('a[href=\"/channels/@me\"]');\n    const ok = isAuthedByPath || hasDM;\n    return ok ? \"true\" : \"false\";   // <‚Äî —Å—Ç—Ä–æ–∫–∞, –Ω–µ boolean\n  } catch(e) { return \"false\"; }",
      "variable": "check_login",
      "remark": ""
    }
  },
  {
    "type": "ifElse",
    "config": {
      "condition": [
        "check_login"
      ],
      "relation": "equal",
      "result": "true",
      "hiddenChildren": false,
      "children": [
        {
          "type": "javaScript",
          "config": {
            "params": [],
            "content": "try {\n    // –¥–∞—ë–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –¥–æ—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è\n    await new Promise(r => setTimeout(r, 600));\n\n    // 1) –±–µ—Ä—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∏–∂–Ω–µ–π –ø–∞–Ω–µ–ª–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ (–ª–æ–∫–∞–ª—å-–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ)\n    const userPanel =\n      document.querySelector('section[class*=\"panels_\"]') || // —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ\n      document.querySelector('section[aria-label=\"User area\"]') || // EN\n      document.querySelector('section[aria-label=\"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å\"]'); // RU\n\n    if (userPanel) {\n      // 2) –≤ –Ω–µ–π –±–µ—Ä—ë–º –∞–≤–∞—Ç–∞—Ä —Å aria-label=\"username, Online/–í —Å–µ—Ç–∏/‚Ä¶\"\n      const avatar = userPanel.querySelector('[role=\"img\"][aria-label]');\n      if (avatar) {\n        const label = (avatar.getAttribute('aria-label') || '').trim();\n        // –±–µ—Ä—ë–º –≤—Å—ë –î–û –ø–µ—Ä–≤–æ–π –∑–∞–ø—è—Ç–æ–π ‚Äî —ç—Ç–æ –∏–º–µ–Ω–Ω–æ username/handle\n        let nick = label.split(',')[0].trim();\n\n        // –ø–æ–¥—á–∏—Å—Ç–∏–º: —É–±–µ—Ä—ë–º —Ö–≤–æ—Å—Ç—ã —Ç–∏–ø–∞ —ç–º–æ–¥–∑–∏ –∏ –ø–æ–≤—Ç–æ—Ä—ã\n        // –ø—Ä–∏–º–µ—Ä \"rnfwy6tzc íÄ≠rnfwy6tzc\" -> \"rnfwy6tzc\"\n        nick = nick\n          .replace(/[\\u200D\\uFE0F]/g, '')          // —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã —ç–º–æ–¥–∑–∏\n          .replace(/\\s*[\\p{Emoji_Presentation}\\p{Extended_Pictographic}].*$/u, '') // –≤—Å—ë –ø–æ—Å–ª–µ —ç–º–æ–¥–∑–∏\n          .replace(/^([A-Za-z0-9._-]{2,32}).*$/, '$1') // –µ—Å–ª–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π \"–¥–∏—Å–∫–æ—Ä–¥–Ω—ã–π\" —Ç–æ–∫–µ–Ω\n          .trim();\n\n        if (nick) return nick;\n      }\n\n      // 3) –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: —Ç–µ–∫—Å—Ç –∏–∑ –±–ª–æ–∫–∞ nameTag –≤ –Ω–∏–∂–Ω–µ–π –ø–∞–Ω–µ–ª–∏\n      const nameEl = userPanel.querySelector('[class*=\"nameTag\"] [class*=\"title\"], [class*=\"nameTag\"]');\n      if (nameEl) {\n        const raw = (nameEl.textContent || '').trim().replace(/\\s+/g, ' ');\n        // –≤—ã—Ç–∞—â–∏–º –¥–∏—Å–∫–æ—Ä–¥–Ω—ã–π —Ç–æ–∫–µ–Ω –Ω–∞–ø–æ–¥–æ–±–∏–µ \"rnfwy6tzc\"\n        const m = raw.match(/[A-Za-z0-9._-]{2,32}/);\n        if (m) return m[0];\n        return raw;\n      }\n    }\n\n    return \"\";\n  } catch (e) {\n    return \"\";\n  }",
            "variable": "ds_nick",
            "remark": ""
          }
        }
      ],
      "remark": "",
      "other": [
        {
          "type": "javaScript",
          "config": {
            "params": [],
            "content": "return \"\";",
            "variable": "nick_to_write",
            "remark": "",
            "_copyItemIndex": "0_6_1",
            "_copyItemType": "children_children"
          }
        }
      ]
    }
  },
  {
    "type": "javaScript",
    "config": {
      "params": [],
      "content": "try {\n    const apx = window.apx || window.adsPower || window.adspower || {};\n    const serial =\n      (window.profileInfo && (window.profileInfo.serialNumber || window.profileInfo.serial_number)) ||\n      (apx && (apx.serialNumber || apx.serial_number)) ||\n      window.serialNumber ||\n      window.serial_number ||\n      '';\n    return String(serial || '').trim();\n  } catch (e) {\n    return '';\n  }",
      "variable": "serial_number",
      "remark": ""
    }
  },
  {
    "type": "googleSheet",
    "config": {
      "type": "read",
      "sheetId": "1U1ZsaQW-V5gB0UkMc7Kdi01lNRYdjmTCpAjKp20d_S8",
      "sheetName": "Discord - check login RPA",
      "rangeType": "range",
      "range": "A:C",
      "template": "",
      "isKey": "0",
      "variable": "gs_existing_rows",
      "remark": ""
    }
  },
  {
    "type": "javaScript",
    "config": {
      "params": [],
      "content": "try {\n    const serial = ('${serial_number}' || '').trim();\n    if (!serial) return '';\n\n    const rawText = '${gs_existing_rows}';\n    let parsed;\n    try {\n      parsed = rawText ? JSON.parse(rawText) : undefined;\n    } catch (jsonError) {\n      parsed = undefined;\n    }\n\n    const raw = parsed || (Array.isArray(window.gs_existing_rows) ? { values: window.gs_existing_rows } : {});\n    const values = Array.isArray(raw?.values) ? raw.values : Array.isArray(raw) ? raw : [];\n\n    let startRow = 1;\n    if (raw && typeof raw.range === 'string') {\n      const match = raw.range.match(/^[A-Z]+(\\d+)/);\n      if (match && match[1]) {\n        startRow = parseInt(match[1], 10) || 1;\n      }\n    }\n\n    for (let idx = 0; idx < values.length; idx += 1) {\n      const row = values[idx];\n      const cell = Array.isArray(row) && row.length ? String(row[0] ?? '').trim() : '';\n      if (cell && cell === serial) {\n        const rowNumber = startRow + idx;\n        return `A${rowNumber}:C${rowNumber}`;\n      }\n    }\n\n    return '';\n  } catch (e) {\n    return '';\n  }",
      "variable": "gs_target_range",
      "remark": ""
    }
  },
  {
    "type": "javaScript",
    "config": {
      "params": [],
      "content": "return ('${gs_target_range}' || '').trim() ? 'true' : 'false';",
      "variable": "gs_has_row",
      "remark": ""
    }
  },
  {
    "type": "ifElse",
    "config": {
      "condition": [
        "gs_has_row"
      ],
      "relation": "equal",
      "result": "true",
      "hiddenChildren": false,
      "children": [
        {
          "type": "googleSheet",
          "config": {
            "type": "write",
            "sheetId": "1U1ZsaQW-V5gB0UkMc7Kdi01lNRYdjmTCpAjKp20d_S8",
            "sheetName": "Discord - check login RPA",
            "rangeType": "range",
            "range": "${gs_target_range}",
            "template": " [ \n    [ \"${serial_number}\", \"${check_login}\", \"${ds_nick}\" ]\n]",
            "isKey": "0",
            "variable": "",
            "remark": ""
          }
        }
      ],
      "remark": "",
      "other": [
        {
          "type": "googleSheet",
          "config": {
            "type": "write",
            "sheetId": "1U1ZsaQW-V5gB0UkMc7Kdi01lNRYdjmTCpAjKp20d_S8",
            "sheetName": "Discord - check login RPA",
            "rangeType": "append",
            "range": "",
            "template": " [ \n    [ \"${serial_number}\", \"${check_login}\", \"${ds_nick}\" ]\n]",
            "isKey": "0",
            "variable": "",
            "remark": ""
          }
        }
      ]
    }
  },
  {
    "type": "closeBrowser",
    "config": {}
  }
]
